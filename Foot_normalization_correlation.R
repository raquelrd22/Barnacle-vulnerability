#######Packages#######

library(tidyverse)
library(corrplot)
library(ggplot2)
library(dplyr)
library(tidyr)
library(ggplot2)
library(gridExtra)
library(reshape2)
library(scales)
library(corrplot)
library(Hmisc)

if(!require(gridExtra)){
  install.packages("gridExtra",dependencies = TRUE,repos='http://cran.us.r-project.org')
}
require(gridExtra)
packageVersion("gridExtra")
# [1] ???2.2.1???

if(!require(corrplot)){
  install.packages("corrplot",dependencies = TRUE,repos='http://cran.us.r-project.org')
}
require(corrplot)
packageVersion("corrplot")
# [1] ???0.77???
if(!require(tidyverse)){
  install.packages("tidyverse",dependencies = TRUE,repos='http://cran.us.r-project.org')
}
require(tidyverse)
packageVersion("tidyverse")
# [1] ???1.2.1???

install.packages("psych")

#######DATA NORMALIZATION#################################

normalize_positive <-function(x) {
  (x - min(x,na.rm = TRUE))/(max(x,na.rm = TRUE)-min(x,na.rm = TRUE))
}

normalize_negative <-function(x) {
  (max(x,na.rm = TRUE)-x)/(max(x,na.rm = TRUE)-min(x,na.rm = TRUE))
}

#1.######################ECOLOGICAL##########
#A. ###########EXPOSURE
##1. read cvs indicators (import database)
Foot_ecological.exposure.INDICATORS

##2. use functions to normalize:
##a) Normalization positive
exposure<- Foot_ecological.exposure.INDICATORS %>% 
  select(fishing.guild, Temp, PP, IR)%>% 
  distinct%>%
  mutate (TempN=normalize_positive(Temp),
          PPN=normalize_positive(PP),
          IRN=normalize_positive(IR))

exposure.N<- exposure [, c(1, 5, 6, 7)]

#B. ###########SENSITIVITY
##1. read cvs indicators (import database)
Foot_ecological.sensitivity.INDICATORS
##2. use functions to normalize:
##a) Normalization positive

sensitivity<- Foot_ecological.sensitivity.INDICATORS %>% 
  select(fishing.guild, Q, ABUND, HARV, EXPLOT)%>% 
  distinct%>%
  mutate (QN=normalize_positive(Q),
          ABUNDN=normalize_positive(ABUND),
          HARVN=normalize_positive(HARV),
          EXPLOTN=normalize_positive(EXPLOT))

sensitivity.N<- sensitivity [, c(1, 6, 7, 8, 9)]

#C. ############RECOVERY POTENTIAL
##1. read cvs indicators (import database)
Foot_ecological.recoverypot.INDICATORS
##2. use functions to normalize:
##a) Normalization positive

recovery.pot<- Foot_ecological.recoverypot.INDICATORS %>% 
  select(fishing.guild, bank.length, bank.area)%>% 
  distinct%>%
  mutate (bank.lengthN=normalize_positive(bank.length),
          bank.areaN=normalize_positive(bank.area))

recovery.potN<- recovery.pot [, c(1, 4, 5)]

##########MATRIX DE CORRELACIONES#############
# READ DE DATA
corr.matrix<- merge(exposure.N, sensitivity.N)
corr.matrix2<- merge(corr.matrix, recovery.potN)

# Ecological correlations
library(corrplot)

cor.eco_indicators.matrix <- (corr.matrix2 [ ,2:10])
ecological_correlation <- cor(cor.eco_indicators.matrix, use="pairwise.complete.obs")
p1 <- corrplot(ecological_correlation, order ="AOE")


#2. ######################SOCIOECONOMIC##########
##1. read cvs indicators (import database)
#A. SENSITIVITY
Foot_socioeco.sensitivity.INDICATORS

##2. use functions to normalize:
##a) Normalization positive
sensitivity.SE<- Foot_socioeco.sensitivity.INDICATORS %>% 
  select(fishing.guild, NFISHERS, FDAYS, BENEFIT, CATCH.V, KG.SOLD, DAYS.SOLD, POUCH, ISO, UNEMP)%>% 
  distinct%>%
  mutate (NFISHERSN=normalize_positive(NFISHERS),
          FDAYSN=normalize_positive(FDAYS),
          BENEFITN=normalize_positive(BENEFIT),
          CATCH.VN=normalize_positive(CATCH.V),
          KG.SOLDN=normalize_positive(KG.SOLD),
          DAYS.SOLDN=normalize_positive(DAYS.SOLD),
          POUCHN=normalize_positive(POUCH),
          ISON=normalize_positive(ISO),
          UNEMPN=normalize_positive(UNEMP))

sensitivity.SE.N<- sensitivity.SE [, c(1, 11:19)]

a <- sensitivity.SE.N [, c(2:10)]
b <- cor(a, use = "pairwise.complete.obs")
p2 <- corrplot(b, order ="AOE")


#B. ADAPTIVE CAPACITY
##1. read cvs indicators (import database)
Boat.socioeco.adaptcap.INDICATORS<- read.csv("data/CSV_socio.eco_boat/Boat.socioeco.adaptcap.INDICATORS.csv", sep=";")
##2. use functions to normalize:
##a) Normalization positive
Foot_socioeco.adaptcap.INDICATORS

adapt.cap<- Foot_socioeco.adaptcap.INDICATORS %>% 
  select(fishing.guild, CPI, GROSS.SALARY, POB.RISK, RESOURCE.DEP, INCOME.DEP, TOURIST, MARKET, ROTATION, CLOUSURE)%>% 
  distinct%>%
  mutate (CPIN=normalize_positive(CPI),
          GROSS.SALARYN=normalize_positive(GROSS.SALARY),
          POB.RISKN=normalize_positive(POB.RISK),
          RESOURCE.DEPN= (RESOURCE.DEP),
          INCOME.DEPN= (INCOME.DEP),
          TOURISTN=normalize_positive(TOURIST),
          MARKETN=normalize_positive(MARKET),
          ROTATION.N=normalize_positive(ROTATION),
          CLOUSURE.N=normalize_positive(CLOUSURE))%>%
  rowwise()

adapt.cap.N<- adapt.cap [, c(1,  11:19)]
##########MATRIX DE CORRELACIONES#############
# READ DE DATA
SE.corr.matrix<- merge(sensitivity.SE.N, adapt.cap.N)

# Socio-economic correlations

c <- adapt.cap.N [, c(2:4, 7:10)]

d <- cor(c, use = "pairwise.complete.obs")
#p2 <- corrplot(b, order ="AOE")

#añadir las variables que dan error
#variables_chungas  
#SE.corr.matrix<- merge(variables_chungas, adapt.cap.N)

cor.socioeco_indicators.matrix <- (SE.corr.matrix [ ,2:19])

socioeco_correlation <- cor(cor.socioeco_indicators.matrix, use = "pairwise.complete.obs")
p2 <- corrplot(socioeco_correlation, order ="AOE")


####FACTORS_ECOLOGICAL#####
#a. ecological exposure
CLIME= TempN-PPN-IRN
EXPOSURE=CLIME

#b. ecological sensitivity
Quality_change= QualityN
Quality_change

Quantity_change= AbundanceN+HarvN+ExplotN
Quantity_change

SENSITIVITY= Quality_change+Quantity_change
SENSITIVITY

#c. ecological recovery potencial
Habitat.extend= bank.lengthN+bank.areaN
Habitat.extend

RECOVERY.POT=Habitat.extend

#Ecological vulnerability
ECOLOGICAL_VULNERABILITY= EXPOSURE+SENSITIVITY-RECOVERY.POTENCIAL


####FACTORS_SOCIOECONOMIC####
#a.socioeco_sensitivity
WORK.OPERATION=NFishersN+FdaysN
WORK.OPERATION

PROFIT= BenefitN+Catch.VN+Kg.soldN+Days.soldN
PROFIT

POUCH=PouchN
POUCH

EMPLOY= IsoN+UnempN
EMPLOY

SENSITIVITY.SE= WORK.OPERATION+PROFIT+EMPLOY+POUCH
SENSITIVITY.SE

#b. socio_eco adaptive capacity
ECONOMIC.STRENGTH= Gross.salaryN-CPIN #Revisar si es + o -
ECONOMIC.STRENGTH

DEPENDENCY=Pob.riskN+Resour.depN+MarketN
DEPENDENCY

MANGMT.STRATEGIES= RotationN+ClousureN

LIVELIHOOD.DIV=TourismN+Income.depN
LIVELIHOOD.DIV

ADAPTIVE.CAPACITY= ECONOMIC.STRENGTH + MANGMT.STRATEGIES+ LIVELIHOOD.DIV- DEPENDENCY
ADAPTIVE.CAPACITY

#########Socio-ecological vulnerabiliy########
SOCIO_ECOLOGICAL.VULNERABILITY= ECOLOGICAL_VULNERABILITY+SENSITIVITY.SE-ADAPTIVE.CAPACITY